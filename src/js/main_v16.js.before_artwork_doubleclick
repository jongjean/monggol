// ì „ì—­ ë³€ìˆ˜ v16
let scene, camera, renderer;

console.log('ğŸ¬ main.js v13.0 - í…ŒìŠ¤íŠ¸');

let threeInitialized = false;

window.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        const openingScene = document.getElementById('opening-scene');
        if (loadingScreen) loadingScreen.style.display = 'none';
        if (openingScene) {
            openingScene.classList.remove('hidden');
            openingScene.style.display = 'flex';
        }
    }, 1000);

    const enterBtn = document.getElementById('enter-btn');
    if (enterBtn) {
        enterBtn.addEventListener('click', function() {
            const openingScene = document.getElementById('opening-scene');
            const exhibitionSpace = document.getElementById('exhibition-space');
            if (openingScene) openingScene.style.display = 'none';
            if (exhibitionSpace) {
                exhibitionSpace.classList.remove('hidden');
                exhibitionSpace.style.display = 'block';
                exhibitionSpace.style.position = 'fixed';
                exhibitionSpace.style.top = '0';
                exhibitionSpace.style.left = '0';
                exhibitionSpace.style.width = '100vw';
                exhibitionSpace.style.height = '100vh';
                exhibitionSpace.style.zIndex = '9999';
            }
            setTimeout(initThreeJS, 100);
        }, { once: true });
    }
});

function initThreeJS() {
    if (threeInitialized) return;
    threeInitialized = true;
    console.log('ğŸš€ Three.js v13.0');

    const container = document.getElementById('exhibition-space');
    if (!container) return;

    scene = new THREE.Scene();
    // scene.background = new THREE.Color(0x87CEEB); // ì£¼ì„ ì²˜ë¦¬
    // scene.fog ì œê±° - í•˜ëŠ˜ ë³´ì´ë„ë¡

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.001, 1000);
    camera.position.set(0, 3, 10);
    camera.lookAt(0, 2, 0);
    
    // ì´ˆê¸° ì¹´ë©”ë¼ ìœ„ì¹˜ ì €ì¥
    window.initialCameraPosition = {
        x: camera.position.x,
        y: camera.position.y,
        z: camera.position.z
    };
    console.log('âœ… ì´ˆê¸° ì¹´ë©”ë¼ ìœ„ì¹˜ ì €ì¥:', window.initialCameraPosition);

    const canvas = document.createElement('canvas');
    canvas.style.touchAction = 'none';
    canvas.style.userSelect = 'none';
    canvas.style.webkitUserSelect = 'none';
    renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
    window.scene = scene;
    window.camera = camera;
    window.renderer = renderer;

    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(10, 20, 10);
    scene.add(directionalLight);

    // í…ŒìŠ¤íŠ¸: ë¹¨ê°„ í•˜ëŠ˜ êµ¬ì²´
    // í•˜ëŠ˜ êµ¬ì²´ (khuvsgul_sky_only.jpg?v=1766679064)
    const skyGeometry = new THREE.SphereGeometry(450, 60, 40);
    const skyLoader = new THREE.TextureLoader();
    skyLoader.load('images/background/khuvsgul_sky_only.jpg?v=1766679064', (skyTexture) => {
        const skyMaterial = new THREE.MeshBasicMaterial({
            map: skyTexture,
            side: THREE.BackSide
        });
        const sky = new THREE.Mesh(skyGeometry, skyMaterial);
        scene.add(sky);
        console.log('ğŸŒ… í•˜ëŠ˜ í…ìŠ¤ì²˜ ë¡œë“œ ì™„ë£Œ');
    });

    // ë°”ë‹¥
    const groundLoader = new THREE.TextureLoader();
    groundLoader.load('images/background/khuvsgul_lake.jpg', (groundTexture) => {
        const groundGeometry = new THREE.CircleGeometry(150, 64);
        const groundMaterial = new THREE.MeshStandardMaterial({ 
            map: groundTexture,
            roughness: 0.3,
            metalness: 0.1,
            transparent: true,
            opacity: 0.85
        });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = 0;
        scene.add(ground);
    });

    // ì‘í’ˆ ë°°ì¹˜ (32ê°œ)
    const artworks = [];
    const artworkData = [];
    const radius = 25; // ê°„ê²© ë„“ê²Œ
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    window.raycaster = raycaster;

    for (let i = 0; i < 32; i++) {
        const angle = (i / 32) * Math.PI * 2;
        const x = Math.cos(angle) * radius;
        const z = Math.sin(angle) * radius;

        const frameGroup = new THREE.Group();
        frameGroup.userData = { artworkIndex: i + 1 };

        const imgNum = String(i + 1).padStart(3, '0');
        const imagePath = `images/artworks/${imgNum}.jpg`;
        artworkData[i] = imagePath;
        if (imgNum === "012") frameGroup.userData.artworkId = "012";

        const loader = new THREE.TextureLoader();
        loader.load(imagePath, (texture) => {
            const imgGeometry = new THREE.PlaneGeometry(3.0, 2.0);
            const imgMaterial = new THREE.MeshBasicMaterial({ map: texture });
            const imgMesh = new THREE.Mesh(imgGeometry, imgMaterial);
            frameGroup.add(imgMesh);
        });

        frameGroup.position.set(x, 2.5, z);
        frameGroup.lookAt(0, 2.5, 0);
        scene.add(frameGroup);
        artworks.push(frameGroup);
    }

    let isDragging = false;
    let previousMouseX = 0;
    let previousMouseY = 0;
    let cameraAngleH = 0;
    let cameraAngleV = 0.1;
    let cameraRadius = 10;

    function updateCameraPosition() {
        const y = Math.sin(cameraAngleV) * cameraRadius + 2;
        const horizontalRadius = Math.cos(cameraAngleV) * cameraRadius;
        const x = Math.sin(cameraAngleH) * horizontalRadius;
        const z = Math.cos(cameraAngleH) * horizontalRadius;
        camera.position.set(x, y, z);
        camera.lookAt(0, 2, 0);
    
    // ì´ˆê¸° ì¹´ë©”ë¼ ìœ„ì¹˜ ì €ì¥
    window.initialCameraPosition = {
        x: camera.position.x,
        y: camera.position.y,
        z: camera.position.z
    };
    console.log('âœ… ì´ˆê¸° ì¹´ë©”ë¼ ìœ„ì¹˜ ì €ì¥:', window.initialCameraPosition);
        
        const minFOV = 15;
        const maxFOV = 75;
        const t = Math.max(0, Math.min(1, (cameraRadius - 0.5) / 29.5));
        camera.fov = minFOV + (maxFOV - minFOV) * t;
        camera.updateProjectionMatrix();
    }

    canvas.addEventListener('mousedown', (e) => {
        isDragging = true;
        previousMouseX = e.clientX;
        previousMouseY = e.clientY;
    });

    canvas.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const deltaX = e.clientX - previousMouseX;
        const deltaY = previousMouseY - e.clientY;
        cameraAngleH += deltaX * 0.002;
        cameraAngleV += deltaY * 0.001;
        cameraAngleV = Math.max(0, Math.min(Math.PI / 4, cameraAngleV));
        updateCameraPosition();
        previousMouseX = e.clientX;
        previousMouseY = e.clientY;
    });

    canvas.addEventListener('mouseup', () => { isDragging = false; });

    // í„°ì¹˜ ì»¨íŠ¸ë¡¤ (ìŠ¤ë§ˆíŠ¸í°)
    let initialPinchDistance = 0;

    canvas.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
            isDragging = true;
            previousMouseX = e.touches[0].clientX;
            previousMouseY = e.touches[0].clientY;
        } else if (e.touches.length === 2) {
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            initialPinchDistance = Math.sqrt(dx * dx + dy * dy);
        }
    });

    canvas.addEventListener('touchmove', (e) => {
        if (e.touches.length === 1 && isDragging) {
            e.preventDefault();
            const deltaX = e.touches[0].clientX - previousMouseX;
            const deltaY = previousMouseY - e.touches[0].clientY;
            cameraAngleH += deltaX * 0.002;
            cameraAngleV += deltaY * 0.001;
            cameraAngleV = Math.max(0, Math.min(Math.PI / 4, cameraAngleV));
            updateCameraPosition();
            previousMouseX = e.touches[0].clientX;
            previousMouseY = e.touches[0].clientY;
        } else if (e.touches.length === 2) {
            e.preventDefault();
            const dx = e.touches[0].clientX - e.touches[1].clientX;
            const dy = e.touches[0].clientY - e.touches[1].clientY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const delta = (initialPinchDistance - distance) * 0.05;
            cameraRadius += delta;
            if (cameraRadius < 0.5) cameraRadius = 0.5;
            if (cameraRadius > 30) cameraRadius = 30;
            updateCameraPosition();
            initialPinchDistance = distance;
        }
    }, { passive: false });

    canvas.addEventListener('touchend', () => {
        isDragging = false;
    });
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        cameraRadius += e.deltaY * 0.005;
        if (cameraRadius < 0.5) cameraRadius = 0.5;
        if (cameraRadius > 30) cameraRadius = 30;
        updateCameraPosition();
    }, { passive: false });

    let lastClickTime = 0;
    canvas.addEventListener('click', (event) => {
        const currentTime = Date.now();
        const isDoubleClick = currentTime - lastClickTime < 300;
        lastClickTime = currentTime;
        if (isDragging) return;

        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(artworks, true);
        
        if (intersects.length > 0 && isDoubleClick) {
            const clicked = intersects[0].object.parent;
            const artworkIndex = clicked.userData.artworkIndex;
            const imagePath = artworkData[artworkIndex - 1];
            
            const popup = document.createElement('div');
            popup.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.95);z-index:10000;display:flex;align-items:center;justify-content:center;cursor:pointer;';
            const img = document.createElement('img');
            img.src = imagePath;
            img.style.cssText = 'max-width:90vw;max-height:90vh;object-fit:contain;';
            popup.appendChild(img);
            document.body.appendChild(popup);
            popup.onclick = () => document.body.removeChild(popup);
        }
    });

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
    window.scene = scene;
    window.camera = camera;
    window.renderer = renderer;

        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
    }
    animate();

    console.log('âœ… v13.0 ì™„ë£Œ');
}

console.log('âœ… main.js v13.0');



// ============================================
// animate ë£¨í”„ì— ê°€ì´ë“œ ì—…ë°ì´íŠ¸ í†µí•©
// ============================================

// requestAnimationFrame í›„í¬
(function() {
    const originalRAF = window.requestAnimationFrame;
    window.requestAnimationFrame = function(callback) {
        return originalRAF.call(window, function(time) {
            // ê°€ì´ë“œ ì—…ë°ì´íŠ¸
            if (typeof animateGuide === 'function') {
            }
            // ì›ë˜ ì½œë°± ì‹¤í–‰
            callback(time);
        });
    };
})();

console.log('âœ… animate ë£¨í”„ í†µí•© ì™„ë£Œ');



// ============================================

// ============================================

// ============================================

// HTML ê³ ì • ê°€ì´ë“œ
function createHTMLGuide() {
    if (document.getElementById('fixedGuide')) return;
    document.body.insertAdjacentHTML('beforeend', '<div id="fixedGuide" class="fixed-guide"><img src="images/guide_on_horse.png" alt="AI ê°€ì´ë“œ"></div>');
    console.log('âœ… HTML ê³ ì • ê°€ì´ë“œ ìƒì„±');
}

function checkGuideProximity() {
    const guide = document.getElementById('fixedGuide');
    if (!guide || !camera || !scene) return;
    let near = false;
    scene.children.forEach(c => {
        if (c.userData && c.userData.artworkId && camera.position.distanceTo(c.position) < 5) near = true;
    });
    guide.classList.toggle('near-artwork', near);
}

setTimeout(() => createHTMLGuide(), 2000);
setInterval(() => checkGuideProximity(), 200);


// ì´ˆê¸°í™”




// ==================== 3D ë„ìŠ¨íŠ¸: ì…ì¥ í›„ì—ë§Œ í‘œì‹œ ====================

setTimeout(() => {
}, 2000);



// ==================== 3D ê°¤ëŸ¬ë¦¬ UI ì‹œìŠ¤í…œ (ìµœì¢…) ====================
(function() {
  console.log('âœ… 3D ê°¤ëŸ¬ë¦¬ UI ì‹œìŠ¤í…œ ë¡œë“œ');
  
  function showUI() {
    var ui = document.querySelector('.gallery-top-left-ui');
    if (!ui) {
      console.warn('âš ï¸ gallery-top-left-ui ì—†ìŒ');
      return;
    }
    
    ui.style.display = 'flex';
    console.log('âœ… UI í‘œì‹œ ì™„ë£Œ');
    
    var video = document.querySelector('.docent-video-ui');
    var player = document.getElementById('greetingPlayer');
    
    if (video && player) {
      video.addEventListener('click', function() {
        player.style.display = 'block';
        console.log('ğŸ¤ ì¸ì‚¬ë§ ì—´ë¦¼');
      });
    }
  }
  
  window.addEventListener('load', function() {
    var btn = document.querySelector('.enter-btn, #enter-btn, [class*="enter"]');
    if (btn) {
      btn.addEventListener('click', function() {
        setTimeout(showUI, 1500);
      });
    }
    
    setTimeout(function() {
      var ui = document.querySelector('.gallery-top-left-ui');
      if (ui && ui.style.display !== 'flex') {
        showUI();
      }
    }, 8000);
  });
})();


// ==================== ì¸ì‚¬ë§ í”Œë ˆì´ì–´ ì‹œìŠ¤í…œ (ì•ˆì „) ====================
(function() {
  window.addEventListener('load', function() {
    const audio = document.getElementById('greeting-audio-fixed');
    const playBtn = document.getElementById('play-btn-fixed');
    const pauseBtn = document.getElementById('pause-btn-fixed');
    const stopBtn = document.getElementById('stop-btn-fixed');
    const progressBar = document.getElementById('progress-bar-fixed');
    const timeDisplay = document.getElementById('time-display-fixed');
    
    // ìš”ì†Œ ì¡´ì¬ í™•ì¸
    if (!audio || !playBtn || !pauseBtn || !stopBtn || !progressBar || !timeDisplay) {
      console.warn('âš ï¸ í”Œë ˆì´ì–´ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      return;
    }
    
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return mins + ':' + (secs < 10 ? '0' : '') + secs;
    }
    
    playBtn.addEventListener('click', function() {
      audio.play();
      playBtn.style.display = 'none';
      pauseBtn.style.display = 'flex';
    });
    
    pauseBtn.addEventListener('click', function() {
      audio.pause();
      pauseBtn.style.display = 'none';
      playBtn.style.display = 'flex';
    });
    
    stopBtn.addEventListener('click', function() {
      audio.pause();
      audio.currentTime = 0;
      pauseBtn.style.display = 'none';
      playBtn.style.display = 'flex';
      progressBar.value = 0;
    });
    
    audio.addEventListener('timeupdate', function() {
      if (audio.duration) {
        const percent = (audio.currentTime / audio.duration) * 100;
        progressBar.value = percent;
        timeDisplay.textContent = formatTime(audio.currentTime) + ' / ' + formatTime(audio.duration);
      }
    });
    
    progressBar.addEventListener('input', function() {
      const time = (progressBar.value / 100) * audio.duration;
      audio.currentTime = time;
    });
    
    audio.addEventListener('ended', function() {
      pauseBtn.style.display = 'none';
      playBtn.style.display = 'flex';
      progressBar.value = 0;
    });
    
    console.log('âœ… ì¸ì‚¬ë§ í”Œë ˆì´ì–´ ì´ˆê¸°í™” ì™„ë£Œ');
  });
})();

// ==================== ìš°ì¸¡ ì œëª© ë¸”ë¡ í‘œì‹œ ====================
(function() {
  function showRightTitle() {
    var titleBlock = document.querySelector('.title-block-right');
    if (titleBlock) {
      titleBlock.style.cssText = `
        position: fixed !important;
        top: 20px !important;
        left: 260px !important;
        z-index: 999999 !important;
        display: block !important;
        background: rgba(20,20,20,0.85) !important;
        padding: 15px 20px !important;
        border-radius: 8px;
        border: 2px solid rgba(212,175,55,0.6);
        box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      `;
      
      var mainTitle = titleBlock.querySelector('.main-title-ui');
      if (mainTitle) {
        mainTitle.style.cssText = 'display: block !important; font-size: 32px !important; font-weight: 700; color: rgba(255,255,255,0.95) !important; margin: 0 0 10px 0; text-shadow: 0 4px 12px rgba(0,0,0,0.8);';
      }
      
      var subtitle = titleBlock.querySelector('.subtitle-ui');
      if (subtitle) {
        subtitle.style.cssText = 'display: block !important; font-size: 18px !important; font-weight: 300; color: rgba(255,255,255,0.8) !important; margin: 0; text-shadow: 0 3px 10px rgba(0,0,0,0.7);';
      }
      
      console.log('âœ… ìš°ì¸¡ ì œëª© í‘œì‹œ');
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', showRightTitle);
  } else {
    showRightTitle();
  }
  setTimeout(showRightTitle, 500);
  setTimeout(showRightTitle, 1000);
})();


// ==================== ë¡œë”©/ì˜¤í”„ë‹ í™”ë©´ ì¤‘ì•™ ë°°ì¹˜ ====================
(function() {
  function centerScreens() {
    // ë¡œë”© í™”ë©´ ì¤‘ì•™ ë°°ì¹˜
    var loadingScreen = document.getElementById('loading-screen');
    if (loadingScreen) {
      loadingScreen.style.cssText = `
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 10000 !important;
      `;
      
      var loadingContent = loadingScreen.querySelector('.loading-content');
      if (loadingContent) {
        loadingContent.style.cssText = 'text-align: center !important;';
      }
      
      console.log('âœ… ë¡œë”© í™”ë©´ ì¤‘ì•™ ë°°ì¹˜');
    }
    
    // ì˜¤í”„ë‹ í™”ë©´ ì¤‘ì•™ ë°°ì¹˜
    var openingScene = document.getElementById('opening-scene');
    if (openingScene) {
      openingScene.style.cssText = `
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 9999 !important;
      `;
      
      var openingContent = openingScene.querySelector('.opening-content');
      if (openingContent) {
        openingContent.style.cssText = `
          text-align: center !important;
          display: flex !important;
          flex-direction: column !important;
          align-items: center !important;
          gap: 30px !important;
        `;
        
        var titleSub = openingContent.querySelector('.title-sub');
        if (titleSub) {
          titleSub.style.cssText = 'font-size: 48px !important; margin: 0 !important;';
        }
        
        var titleDesc = openingContent.querySelector('.title-desc');
        if (titleDesc) {
          titleDesc.style.cssText = 'font-size: 24px !important; margin: 20px 0 !important;';
        }
        
        var enterBtn = openingContent.querySelector('.enter-button');
        if (enterBtn) {
          enterBtn.style.cssText = 'margin: 20px auto 0 !important; display: block !important;';
        }
      }
      
      console.log('âœ… ì˜¤í”„ë‹ í™”ë©´ ì¤‘ì•™ ë°°ì¹˜');
    }
  }
  
  // ì¦‰ì‹œ ì‹¤í–‰
  centerScreens();
  
  // DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', centerScreens);
  }
  
  // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ë‹¤ì‹œ ì‹¤í–‰
  setTimeout(centerScreens, 100);
  setTimeout(centerScreens, 500);
})();


// ==================== ë¡œë”© í™”ë©´ ì œëª© í‘œì‹œ ====================
(function() {
  function styleLoadingScreen() {
    var loadingScreen = document.getElementById('loading-screen');
    if (loadingScreen) {
      loadingScreen.style.cssText = `
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background: linear-gradient(135deg, #1a2a4e 0%, #0d1929 100%) !important;
        z-index: 10000 !important;
      `;
      
      var loadingContent = loadingScreen.querySelector('.loading-content');
      if (loadingContent) {
        loadingContent.style.cssText = `
          text-align: center !important;
          display: flex !important;
          flex-direction: column !important;
          align-items: center !important;
          gap: 20px !important;
        `;
      }
      
      console.log('âœ… ë¡œë”© í™”ë©´ ìŠ¤íƒ€ì¼ ì ìš©');
    }
  }
  
  // ì¦‰ì‹œ ì‹¤í–‰
  styleLoadingScreen();
  
  // íƒ€ì´ë° ë³´ì¥
  setTimeout(styleLoadingScreen, 50);
  setTimeout(styleLoadingScreen, 100);
})();


// ==================== í”Œë ˆì´ì–´ í”„ë ˆì„ ê°„ê²© ì¡°ì • ====================
(function() {
  function adjustPlayerSpacing() {
    var player = document.querySelector('.greeting-player-fixed');
    if (player) {
      player.style.cssText = `
        display: block !important;
        background: rgba(20,20,20,0.9) !important;
        padding: 12px 12px !important;
        border-radius: 8px;
        width: 200px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        border: 2px solid rgba(212,175,55,0.7);
        min-height: 70px !important;
      `;
      
      var progressContainer = player.querySelector('.progress-container');
      if (progressContainer) {
        progressContainer.style.cssText = 'display: block !important; width: 100%; margin-bottom: 12px !important;';
      }
      
      var controls = player.querySelector('.player-controls');
      if (controls) {
        controls.style.cssText = 'display: flex !important; align-items: center; gap: 8px; justify-content: space-between; margin-top: 4px !important;';
      }
      
      console.log('âœ… í”Œë ˆì´ì–´ ê°„ê²© ì¡°ì •');
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', adjustPlayerSpacing);
  } else {
    adjustPlayerSpacing();
  }
  setTimeout(adjustPlayerSpacing, 500);
  setTimeout(adjustPlayerSpacing, 1000);
})();


// ==================== í”Œë ˆì´ì–´ ë²„íŠ¼ ê°„ê²© ì¡°ì • ====================
(function() {
  function adjustPlayerButtonSpacing() {
    var playerLeft = document.querySelector('.player-left');
    if (playerLeft) {
      playerLeft.style.cssText = 'display: flex !important; align-items: center; gap: 10px !important; flex: 1;';
      
      console.log('âœ… í”Œë ˆì´ì–´ ë²„íŠ¼ ê°„ê²© ì¡°ì •');
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', adjustPlayerButtonSpacing);
  } else {
    adjustPlayerButtonSpacing();
  }
  setTimeout(adjustPlayerButtonSpacing, 500);
  setTimeout(adjustPlayerButtonSpacing, 1000);
})();


// ==================== í”Œë ˆì´ì–´ ë²„íŠ¼ ê°„ê²© ëŒ€í­ ì¦ê°€ ====================
(function() {
  function widerButtonSpacing() {
    var playerLeft = document.querySelector('.player-left');
    if (playerLeft) {
      playerLeft.style.cssText = 'display: flex !important; align-items: center; gap: 15px !important; flex: 1;';
    }
    
    var playerTitle = document.querySelector('.player-title');
    if (playerTitle) {
      playerTitle.style.cssText = 'display: inline-block !important; font-size: 11px !important; color: #d4af37 !important; min-width: 30px !important; margin-right: 5px !important;';
    }
    
    console.log('âœ… ë²„íŠ¼ ê°„ê²© 15pxë¡œ ì¦ê°€');
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', widerButtonSpacing);
  } else {
    widerButtonSpacing();
  }
  setTimeout(widerButtonSpacing, 500);
  setTimeout(widerButtonSpacing, 1000);
})();


// ==================== ì¸ì‚¬ í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ ====================
(function() {
  function centerPlayerTitle() {
    var playerTitle = document.querySelector('.player-title');
    if (playerTitle) {
      playerTitle.style.cssText = `
        display: inline-block !important;
        font-size: 11px !important;
        color: #d4af37 !important;
        min-width: 30px !important;
        margin-right: 5px !important;
        text-align: center !important;
      `;
      
      console.log('âœ… ì¸ì‚¬ í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬');
    }
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', centerPlayerTitle);
  } else {
    centerPlayerTitle();
  }
  setTimeout(centerPlayerTitle, 500);
  setTimeout(centerPlayerTitle, 1000);
})();


// ==================== í”Œë ˆì´ì–´ ë„ˆë¹„ ì¦ê°€ ====================
(function() {
  function widenPlayer() {
    var player = document.querySelector('.greeting-player-fixed');
    if (player) {
      player.style.cssText = `
        display: block !important;
        background: rgba(20,20,20,0.9) !important;
        padding: 12px 12px !important;
        border-radius: 8px;
        width: 240px !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        border: 2px solid rgba(212,175,55,0.7);
        min-height: 70px !important;
      `;
    }
    
    var playerLeft = document.querySelector('.player-left');
    if (playerLeft) {
      playerLeft.style.cssText = 'display: flex !important; align-items: center; gap: 12px !important; flex: 1;';
    }
    
    var playerTitle = document.querySelector('.player-title');
    if (playerTitle) {
      playerTitle.style.cssText = `
        display: inline-block !important;
        font-size: 11px !important;
        color: #d4af37 !important;
        min-width: 30px !important;
        text-align: center !important;
      `;
    }
    
    console.log('âœ… í”Œë ˆì´ì–´ ë„ˆë¹„ 240pxë¡œ ì¦ê°€');
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', widenPlayer);
  } else {
    widenPlayer();
  }
  setTimeout(widenPlayer, 500);
  setTimeout(widenPlayer, 1000);
})();


// ==================== ì‘í’ˆ í•´ì„¤ ë°ì´í„° ====================
const artworkData = {
  '012': {
    title: 'í•œ ë•Œ í•œ ê³³ì„ ìŠ¤ì³ê°„ ì‚¬ê³„',
    description: `ê²€í‘¸ë¥´ê²Œ í™”ì°½í•˜ë˜ í•˜ëŠ˜ì—ì„œ ì‚°ì„ í•˜ë‚˜ ë„˜ì–´ì„œì
ê°‘ìê¸° ëˆˆë³´ë¼ê°€ íœ˜ëª°ì•„ì³¤ë‹¤. 
ë°”ëŒì´ ë„ˆë¬´ë„ ì„¸ ëˆˆì´ ìˆ˜í‰ìœ¼ë¡œ ë‚´ë ¸ë‹¤. 
í ì¹« ìˆœê°„ ë¬´ì—‡ì¸ê°€ ì§€ë‚˜ê°€ëŠ” ê°€ í–ˆë”ë‹ˆ 
ëˆˆë³´ë¼ ì†ì„ ë¬´ì„œìš´ ì†ë„ë¡œ ì§ˆì£¼í•˜ëŠ” 
ì§•í‚¤ìŠ¤ì¹¸ì˜ í›„ì˜ˆê°€ ìˆì—ˆë‹¤. 
ë¯¸ì²˜ ì¹´ë©”ë¼ë¥¼ ëŒ€ì§€ ëª»í•  ì •ë„ë¡œ 
ëˆˆ ê¹œì§í•  ìƒˆ ëˆˆë³´ë¼ ì†ìœ¼ë¡œ ì‚¬ë¼ì¡Œë‹¤. 
ì…”í„°ë¥¼ ëˆ„ë¥´ì§€ ëª»í•œ ê²ƒì´ ë„ˆë¬´ë„ ì•ˆíƒ€ê¹Œì› ë‹¤.
í•œì°¸ í›„ ê·¸ê°€ ëˆˆë³´ë¼ ì†ì—ì„œ ëª¨ìŠµì„ ë“œëŸ¬ëƒˆë‹¤.
ë°±ì—¬ ë§ˆë¦¬ì˜ ì–‘ë–¼ë¥¼ ì´ëŒê³  ëŒì•„ì˜¤ê³  ìˆì—ˆë‹¤. 
ê°‘ìê¸° ëª°ì•„ì¹œ ëˆˆë³´ë¼ì— 
ì–‘ë–¼ë“¤ì´ íœ©ì“¸ë ¤ ê°€ëŠ” ê²ƒì„ êµ¬í•˜ê¸° ìœ„í•´ 
ì „ì†ë ¥ìœ¼ë¡œ ë‹¬ë ¤ê°”ë˜ ê²ƒì´ì—ˆë‹¤.`,
    audioFile: 'audio/artwork_012_commentary.mp3'
  }
};

// ==================== AI ë„ìŠ¨íŠ¸ íŒì—… ì‹œìŠ¤í…œ ====================
(function() {
  let docentPopup = null;
  let docentAudio = null;
  let currentArtwork = null;
  
  function createDocentPopup() {
    // íŒì—… HTML ìƒì„±
    const popupHTML = `
      <div id="docent-popup" class="docent-popup" style="display: none;">
        <div class="docent-popup-overlay"></div>
        <div class="docent-popup-content">
          <button class="docent-close-btn">âˆ’</button>
          
          <!-- í”„ë¡œí•„ ì‚¬ì§„ -->
          <div class="docent-profile">
            <img src="images/guide_on_horse.png" alt="ê°•ì¢…ì§„ ì‘ê°€" class="docent-profile-img">
            <h3 class="docent-profile-name">ê°•ì¢…ì§„ ì‘ê°€</h3>
          </div>
          
          <!-- ì‘í’ˆ ì •ë³´ -->
          <div class="docent-info">
            <h2 class="docent-artwork-title" id="docent-artwork-title"></h2>
            <div class="docent-artwork-desc" id="docent-artwork-desc"></div>
          </div>
          
          <!-- í•´ì„¤ ë“£ê¸° ë²„íŠ¼ -->
          <button class="docent-listen-btn" id="docent-listen-btn">
            ğŸ§ í•´ì„¤ ë“£ê¸°
          </button>
          
          <!-- ì˜¤ë””ì˜¤ ì»¨íŠ¸ë¡¤ëŸ¬ -->
          <div class="docent-audio-controls" id="docent-audio-controls" style="display: none;">
            <audio id="docent-audio"></audio>
            
            <div class="docent-progress-container">
              <input type="range" id="docent-progress-bar" class="docent-progress-bar" min="0" max="100" value="0">
            </div>
            
            <div class="docent-control-buttons">
              <button id="docent-play-btn" class="docent-control-btn">â–¶</button>
              <button id="docent-pause-btn" class="docent-control-btn" style="display:none;">â¸</button>
              <button id="docent-stop-btn" class="docent-control-btn">â¹</button>
              <span id="docent-time-display" class="docent-time-display">0:00 / 0:00</span>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', popupHTML);
    docentPopup = document.getElementById('docent-popup');
    docentAudio = document.getElementById('docent-audio');
    
    // íŒì—… ìŠ¤íƒ€ì¼ ì ìš©
    applyDocentStyles();
    
    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    bindDocentEvents();
    
    console.log('âœ… AI ë„ìŠ¨íŠ¸ íŒì—… ìƒì„± ì™„ë£Œ');
  }
  
  function applyDocentStyles() {
    const popup = document.getElementById('docent-popup');
    if (!popup) return;
    
    popup.style.cssText = `
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      z-index: 100000 !important;
    `;
    
    const overlay = popup.querySelector('.docent-popup-overlay');
    if (overlay) {
      overlay.style.cssText = `
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
      `;
    }
    
    const content = popup.querySelector('.docent-popup-content');
    if (content) {
      content.style.cssText = `
        position: absolute !important;
        top: 50% !important;
        right: 80px !important;
        transform: translateY(-50%) !important;
        width: 400px !important;
        max-height: 80vh !important;
        background: rgba(20,20,20,0.95) !important;
        border: 3px solid rgba(212,175,55,0.8) !important;
        border-radius: 15px !important;
        padding: 30px !important;
        overflow-y: auto !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.8) !important;
      `;
    }
    
    const closeBtn = popup.querySelector('.docent-close-btn');
    if (closeBtn) {
      closeBtn.style.cssText = `
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(212,175,55,0.8);
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        font-size: 20px;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      `;
    }
    
    const profile = popup.querySelector('.docent-profile');
    if (profile) {
      profile.style.cssText = `
        text-align: center;
        margin-bottom: 25px;
      `;
      
      const img = profile.querySelector('.docent-profile-img');
      if (img) {
        img.style.cssText = `
          width: 120px;
          height: 120px;
          border-radius: 50%;
          border: 4px solid rgba(212,175,55,0.8);
          object-fit: cover;
          margin-bottom: 10px;
        `;
      }
      
      const name = profile.querySelector('.docent-profile-name');
      if (name) {
        name.style.cssText = `
          font-size: 18px;
          color: rgba(212,175,55,1);
          margin: 0;
        `;
      }
    }
    
    const info = popup.querySelector('.docent-info');
    if (info) {
      info.style.cssText = `
        margin-bottom: 25px;
      `;
      
      const title = info.querySelector('.docent-artwork-title');
      if (title) {
        title.style.cssText = `
          font-size: 24px;
          color: rgba(255,255,255,0.95);
          margin: 0 0 15px 0;
          text-align: center;
        `;
      }
      
      const desc = info.querySelector('.docent-artwork-desc');
      if (desc) {
        desc.style.cssText = `
          font-size: 15px;
          line-height: 1.8;
          color: rgba(255,255,255,0.85);
          white-space: pre-line;
          max-height: 200px;
          overflow-y: auto;
        `;
      }
    }
    
    const listenBtn = popup.querySelector('.docent-listen-btn');
    if (listenBtn) {
      listenBtn.style.cssText = `
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, rgba(212,175,55,0.9), rgba(180,150,40,0.9));
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        margin-bottom: 20px;
        transition: all 0.3s;
      `;
    }
    
    const audioControls = popup.querySelector('.docent-audio-controls');
    if (audioControls) {
      audioControls.style.cssText = `
        background: rgba(30,30,30,0.8);
        border-radius: 8px;
        padding: 15px;
      `;
      
      const progressContainer = audioControls.querySelector('.docent-progress-container');
      if (progressContainer) {
        progressContainer.style.cssText = `
          margin-bottom: 15px;
        `;
        
        const progressBar = progressContainer.querySelector('.docent-progress-bar');
        if (progressBar) {
          progressBar.style.cssText = `
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
          `;
        }
      }
      
      const controlButtons = audioControls.querySelector('.docent-control-buttons');
      if (controlButtons) {
        controlButtons.style.cssText = `
          display: flex;
          align-items: center;
          gap: 10px;
        `;
        
        const buttons = controlButtons.querySelectorAll('.docent-control-btn');
        buttons.forEach(btn => {
          btn.style.cssText = `
            background: rgba(212,175,55,0.8);
            border: none;
            border-radius: 5px;
            width: 40px;
            height: 40px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
          `;
        });
        
        const timeDisplay = controlButtons.querySelector('.docent-time-display');
        if (timeDisplay) {
          timeDisplay.style.cssText = `
            margin-left: auto;
            font-size: 14px;
            color: rgba(255,255,255,0.8);
            font-family: monospace;
          `;
        }
      }
    }
  }
  
  function bindDocentEvents() {
    const closeBtn = document.querySelector('.docent-close-btn');
    const listenBtn = document.getElementById('docent-listen-btn');
    const playBtn = document.getElementById('docent-play-btn');
    const pauseBtn = document.getElementById('docent-pause-btn');
    const stopBtn = document.getElementById('docent-stop-btn');
    const progressBar = document.getElementById('docent-progress-bar');
    const overlay = document.querySelector('.docent-popup-overlay');
    
    // ë‹«ê¸°
    if (closeBtn) closeBtn.addEventListener('click', closeDocentPopup);
    if (overlay) overlay.addEventListener('click', closeDocentPopup);
    
    // í•´ì„¤ ë“£ê¸° ë²„íŠ¼
    if (listenBtn) {
      listenBtn.addEventListener('click', function() {
        document.getElementById('docent-audio-controls').style.display = 'block';
        docentAudio.play();
        document.getElementById('docent-play-btn').style.display = 'none';
        document.getElementById('docent-pause-btn').style.display = 'inline-flex';
      });
    }
    
    // ì¬ìƒ
    if (playBtn) {
      playBtn.addEventListener('click', function() {
        docentAudio.play();
        playBtn.style.display = 'none';
        pauseBtn.style.display = 'inline-flex';
      });
    }
    
    // ì¼ì‹œì •ì§€
    if (pauseBtn) {
      pauseBtn.addEventListener('click', function() {
        docentAudio.pause();
        pauseBtn.style.display = 'none';
        playBtn.style.display = 'inline-flex';
      });
    }
    
    // ì •ì§€
    if (stopBtn) {
      stopBtn.addEventListener('click', function() {
        docentAudio.pause();
        docentAudio.currentTime = 0;
        pauseBtn.style.display = 'none';
        playBtn.style.display = 'inline-flex';
        progressBar.value = 0;
      });
    }
    
    // ì‹œê°„ ì—…ë°ì´íŠ¸
    if (docentAudio) {
      docentAudio.addEventListener('timeupdate', function() {
        if (docentAudio.duration) {
          const progress = (docentAudio.currentTime / docentAudio.duration) * 100;
          progressBar.value = progress;
          
          const current = formatTime(docentAudio.currentTime);
          const total = formatTime(docentAudio.duration);
          document.getElementById('docent-time-display').textContent = current + ' / ' + total;
        }
      });
      
      docentAudio.addEventListener('ended', function() {
        pauseBtn.style.display = 'none';
        playBtn.style.display = 'inline-flex';
        progressBar.value = 0;
      });
    }
    
    // í”„ë¡œê·¸ë ˆìŠ¤ë°”
    if (progressBar) {
      progressBar.addEventListener('input', function() {
        if (docentAudio.duration) {
          const time = (progressBar.value / 100) * docentAudio.duration;
          docentAudio.currentTime = time;
        }
      });
    }
  }
  
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
  }
  
  function openDocentPopup(artworkNumber) {
    const data = artworkData[artworkNumber];
    if (!data) {
      console.log('âš ï¸ ì‘í’ˆ ë°ì´í„° ì—†ìŒ:', artworkNumber);
      return;
    }
    
    currentArtwork = artworkNumber;
    
    // íŒì—…ì´ ì—†ìœ¼ë©´ ìƒì„±
    if (!docentPopup) {
      createDocentPopup();
    }
    
    // ë°ì´í„° ì±„ìš°ê¸°
    document.getElementById('docent-artwork-title').textContent = data.title;
    document.getElementById('docent-artwork-desc').textContent = data.description;
    docentAudio.src = data.audioFile;
    
    // ì»¨íŠ¸ë¡¤ ì´ˆê¸°í™”
    document.getElementById('docent-audio-controls').style.display = 'none';
    document.getElementById('docent-play-btn').style.display = 'inline-flex';
    document.getElementById('docent-pause-btn').style.display = 'none';
    document.getElementById('docent-progress-bar').value = 0;
    
    // íŒì—… í‘œì‹œ
    docentPopup.style.display = 'block';
    
    console.log('âœ… ë„ìŠ¨íŠ¸ íŒì—… ì—´ë¦¼:', artworkNumber);
  }
  
  function closeDocentPopup() {
    if (docentAudio) {
      docentAudio.pause();
      docentAudio.currentTime = 0;
    }
    if (docentPopup) {
      docentPopup.style.display = 'none';
    }
    console.log('âœ… ë„ìŠ¨íŠ¸ íŒì—… ë‹«í˜');
  }
  
  // ì‘í’ˆ ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ (012ë²ˆë§Œ ì¼ë‹¨ í…ŒìŠ¤íŠ¸)
  function attachArtworkListeners() {
    // Three.js ì‘í’ˆ í´ë¦­ ì´ë²¤íŠ¸ì— ì¶”ê°€í•´ì•¼ í•¨
    // ì¼ë‹¨ ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
    window.openDocentPopup = openDocentPopup;
    console.log('âœ… ë„ìŠ¨íŠ¸ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ');
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachArtworkListeners);
  } else {
    attachArtworkListeners();
  }
  
  setTimeout(attachArtworkListeners, 1000);
})();


// ==================== ì‘í’ˆ í•´ì„¤ ë°ì´í„° ====================

// ==================== AI ë„ìŠ¨íŠ¸ íŒì—… ====================
(function() {
  let popup = null;
  let audio = null;
  
  function createPopup() {
    const html = `
      <div id="ai-docent-popup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:200000;">
        <div style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);" onclick="closeDocent()"></div>
        <div id="docent-content" style="position:absolute;top:50%;right:80px;transform:translateY(-50%);width:400px;max-height:80vh;background:rgba(20,20,20,0.95);cursor:move;box-shadow:0 10px 40px rgba(0,0,0,0.8);border:3px solid rgba(212,175,55,0.8);border-radius:15px;padding:30px;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.8);">
          <button onclick="closeDocent()" style="position:absolute;top:15px;right:15px;background:rgba(212,175,55,0.8);border:none;border-radius:50%;width:35px;height:35px;font-size:20px;color:white;cursor:pointer;">âˆ’</button>
          
          <div style="text-align:center;margin-bottom:25px;">
            <img src="images/guide_on_horse.png" style="width:120px;height:120px;border-radius:50%;border:4px solid rgba(212,175,55,0.8);object-fit:cover;margin-bottom:10px;">
            <h3 style="font-size:18px;color:rgba(212,175,55,1);margin:0;">ê°•ì¢…ì§„ ì‘ê°€</h3>
          </div>
          
          <div style="margin-bottom:25px;">
            <h2 id="docent-title" style="font-size:24px;color:rgba(255,255,255,0.95);margin:0 0 15px 0;text-align:center;"></h2>
            <div id="docent-desc" style="font-size:15px;line-height:1.8;color:rgba(255,255,255,0.85);white-space:pre-line;max-height:200px;overflow-y:auto;"></div>
          </div>
          
          <button id="listen-btn" style="width:100%;padding:15px;background:linear-gradient(135deg,rgba(212,175,55,0.9),rgba(180,150,40,0.9));border:none;border-radius:8px;color:white;font-size:18px;font-weight:bold;cursor:pointer;margin-bottom:20px;">ğŸ§ í•´ì„¤ ë“£ê¸°</button>
          
          <div id="audio-controls" style="display:none;background:rgba(30,30,30,0.8);border-radius:8px;padding:15px;">
            <audio id="docent-audio"></audio>
            <div style="margin-bottom:15px;">
              <input type="range" id="progress" min="0" max="100" value="0" style="width:100%;height:8px;cursor:pointer;">
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
              <button id="play-btn" style="background:rgba(212,175,55,0.8);border:none;border-radius:5px;width:40px;height:40px;color:white;font-size:16px;cursor:pointer;">â–¶</button>
              <button id="pause-btn" style="display:none;background:rgba(212,175,55,0.8);border:none;border-radius:5px;width:40px;height:40px;color:white;font-size:16px;cursor:pointer;">â¸</button>
              <button id="stop-btn" style="background:rgba(212,175,55,0.8);border:none;border-radius:5px;width:40px;height:40px;color:white;font-size:16px;cursor:pointer;">â¹</button>
              <span id="time-display" style="margin-left:auto;font-size:14px;color:rgba(255,255,255,0.8);font-family:monospace;">0:00 / 0:00</span>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', html);
    popup = document.getElementById('ai-docent-popup');
    audio = document.getElementById('docent-audio');
    
    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.getElementById('listen-btn').onclick = function() {
      document.getElementById('audio-controls').style.display = 'block';
      audio.play();
      document.getElementById('play-btn').style.display = 'none';
      document.getElementById('pause-btn').style.display = 'inline-block';
    };
    
    document.getElementById('play-btn').onclick = function() {
      audio.play();
      this.style.display = 'none';
      document.getElementById('pause-btn').style.display = 'inline-block';
    };
    
    document.getElementById('pause-btn').onclick = function() {
      audio.pause();
      this.style.display = 'none';
      document.getElementById('play-btn').style.display = 'inline-block';
    };
    
    document.getElementById('stop-btn').onclick = function() {
      audio.pause();
      audio.currentTime = 0;
      document.getElementById('pause-btn').style.display = 'none';
      document.getElementById('play-btn').style.display = 'inline-block';
      document.getElementById('progress').value = 0;
    };
    
    audio.ontimeupdate = function() {
      if (audio.duration) {
        document.getElementById('progress').value = (audio.currentTime / audio.duration) * 100;
        const formatTime = (s) => Math.floor(s/60) + ':' + (Math.floor(s%60)<10?'0':'') + Math.floor(s%60);
        document.getElementById('time-display').textContent = formatTime(audio.currentTime) + ' / ' + formatTime(audio.duration);
      }
    };
    
    document.getElementById('progress').oninput = function() {
      if (audio.duration) {
        audio.currentTime = (this.value / 100) * audio.duration;
      }
    };
    
    audio.onended = function() {
      document.getElementById('pause-btn').style.display = 'none';
      document.getElementById('play-btn').style.display = 'inline-block';
      document.getElementById('progress').value = 0;
    };
    
    console.log('âœ… ë„ìŠ¨íŠ¸ íŒì—… ìƒì„±');
  }
  
  window.openDocent = function(artworkId) {
    const data = artworkData[artworkId];
    if (!data) return;
    
    if (!popup) createPopup();
    
    document.getElementById('docent-title').textContent = data.title;
    document.getElementById('docent-desc').textContent = data.description;
    audio.src = data.audioFile;
    
    document.getElementById('audio-controls').style.display = 'none';
    document.getElementById('play-btn').style.display = 'inline-block';
    document.getElementById('pause-btn').style.display = 'none';
    document.getElementById('progress').value = 0;
    
    popup.style.display = 'block';
    console.log('âœ… ë„ìŠ¨íŠ¸ ì—´ë¦¼:', artworkId);
  };
  
  window.closeDocent = function() {
    if (audio) {
      audio.pause();
      audio.currentTime = 0;
    }
    if (popup) popup.style.display = 'none';
  };
  
  setTimeout(createPopup, 1000);
})();

// ==================== 012ë²ˆ ì‘í’ˆ ë”ë¸”í´ë¦­ ì—°ê²° ====================
(function() {
  let lastClickTime = 0;
  let lastClickedObject = null;
  
  // ê¸°ì¡´ í´ë¦­ ì´ë²¤íŠ¸ì— ë”ë¸”í´ë¦­ ê°ì§€ ì¶”ê°€
  const canvas = document.querySelector('canvas');
  if (canvas) {
    canvas.addEventListener('click', function(e) {
      const now = Date.now();
      
      // ë”ë¸”í´ë¦­ ê°ì§€ (300ms ì´ë‚´)
      if (now - lastClickTime < 300) {
        // raycasterë¡œ í´ë¦­ëœ ê°ì²´ í™•ì¸
        const mouse = { x: (e.clientX / window.innerWidth) * 2 - 1, y: -(e.clientY / window.innerHeight) * 2 + 1 };
        
        if (window.raycaster && window.camera && window.scene) {
          window.raycaster.setFromCamera(mouse, window.camera);
          const intersects = window.raycaster.intersectObjects(window.scene.children, true);
          
          for (let i = 0; i < intersects.length; i++) {
            const obj = intersects[i].object;
            if (obj.userData && obj.userData.artworkId) {
              const artworkId = obj.userData.artworkId;
              console.log('ğŸ¨ ì‘í’ˆ ë”ë¸”í´ë¦­:', artworkId);
              
              // 012ë²ˆì´ë©´ ë„ìŠ¨íŠ¸ ì—´ê¸°
              if (artworkId === '012') {
                window.openDocent('012');
              }
              break;
            }
          }
        }
      }
      
      lastClickTime = now;
    });
    
    console.log('âœ… ì‘í’ˆ ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°');
  }
})();


// 012ë²ˆ ë„ìŠ¨íŠ¸
(function(){
const data={'012':{title:'í•œ ë•Œ í•œ ê³³ì„ ìŠ¤ì³ê°„ ì‚¬ê³„',description:`ê²€í‘¸ë¥´ê²Œ í™”ì°½í•˜ë˜ í•˜ëŠ˜ì—ì„œ ì‚°ì„ í•˜ë‚˜ ë„˜ì–´ì„œì
ê°‘ìê¸° ëˆˆë³´ë¼ê°€ íœ˜ëª°ì•„ì³¤ë‹¤. 
ë°”ëŒì´ ë„ˆë¬´ë„ ì„¸ ëˆˆì´ ìˆ˜í‰ìœ¼ë¡œ ë‚´ë ¸ë‹¤. 
í ì¹« ìˆœê°„ ë¬´ì—‡ì¸ê°€ ì§€ë‚˜ê°€ëŠ” ê°€ í–ˆë”ë‹ˆ 
ëˆˆë³´ë¼ ì†ì„ ë¬´ì„œìš´ ì†ë„ë¡œ ì§ˆì£¼í•˜ëŠ” 
ì§•í‚¤ìŠ¤ì¹¸ì˜ í›„ì˜ˆê°€ ìˆì—ˆë‹¤. 
ë¯¸ì²˜ ì¹´ë©”ë¼ë¥¼ ëŒ€ì§€ ëª»í•  ì •ë„ë¡œ 
ëˆˆ ê¹œì§í•  ìƒˆ ëˆˆë³´ë¼ ì†ìœ¼ë¡œ ì‚¬ë¼ì¡Œë‹¤. 
ì…”í„°ë¥¼ ëˆ„ë¥´ì§€ ëª»í•œ ê²ƒì´ ë„ˆë¬´ë„ ì•ˆíƒ€ê¹Œì› ë‹¤.

í•œì°¸ í›„ ê·¸ê°€ ëˆˆë³´ë¼ ì†ì—ì„œ ëª¨ìŠµì„ ë“œëŸ¬ëƒˆë‹¤.
ë°±ì—¬ ë§ˆë¦¬ì˜ ì–‘ë–¼ë¥¼ ì´ëŒê³  ëŒì•„ì˜¤ê³  ìˆì—ˆë‹¤. 
ê°‘ìê¸° ëª°ì•„ì¹œ ëˆˆë³´ë¼ì— 
ì–‘ë–¼ë“¤ì´ íœ©ì“¸ë ¤ ê°€ëŠ” ê²ƒì„ êµ¬í•˜ê¸° ìœ„í•´ 
ì „ì†ë ¥ìœ¼ë¡œ ë‹¬ë ¤ê°”ë˜ ê²ƒì´ì—ˆë‹¤.`,audio:'audio/artwork_012_commentary.mp3'}};
let p=null,a=null;
function create(){
if(p)return;
const h=`<div id="doc-pop" style="display:none;position:fixed;top:50%;right:80px;transform:translateY(-50%);z-index:200000;background:rgba(0,0,0,0.5);backdrop-filter:blur(10px) brightness(0.7);width:400px;max-height:80vh;background:rgba(20,20,20,0.95);cursor:move;box-shadow:0 10px 40px rgba(0,0,0,0.8);border:3px solid rgba(212,175,55,0.8);border-radius:15px;padding:30px;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.8);"><div id="doc-drag-header" style="position:absolute;top:0;left:0;right:0;height:50px;cursor:move;z-index:0;"></div><button onclick="document.getElementById('doc-pop').style.display='none';document.getElementById('doc-mini').style.display='block';console.log('âœ… ìµœì†Œí™”');" style="position:absolute;top:15px;right:15px;background:rgba(212,175,55,0.8);border:none;border-radius:50%;width:35px;height:35px;font-size:20px;color:white;cursor:pointer;">âˆ’</button><div style="text-align:center;margin-bottom:25px;"><img src="images/author_profile_012.jpg" style="width:150px;height:150px;border-radius:15px;border:4px solid rgba(212,175,55,0.8);object-fit:cover;margin-bottom:10px;"><h3 style="font-size:18px;color:rgba(212,175,55,1);margin:0;">ê°•ì¢…ì§„ ì‘ê°€</h3></div><div style="margin-bottom:25px;"><h2 id="doc-t" style="font-size:24px;color:#fff;margin:0 0 15px 0;text-align:center;"></h2><div id="doc-d" style="font-size:15px;line-height:1.8;color:rgba(255,255,255,0.85);white-space:pre-line;max-height:200px;overflow-y:auto;"></div></div><button id="listen" style="width:100%;padding:15px;background:linear-gradient(135deg,rgba(212,175,55,0.9),rgba(180,150,40,0.9));border:none;border-radius:8px;color:white;font-size:18px;font-weight:bold;cursor:pointer;margin-bottom:20px;">ğŸ§ í•´ì„¤ ë“£ê¸°</button><div id="ac" style="display:none;background:rgba(30,30,30,0.8);border-radius:8px;padding:15px;"><audio id="da"></audio><div style="margin-bottom:15px;"><input type="range" id="pb" min="0" max="100" value="0" style="width:100%;height:8px;cursor:pointer;"></div><div style="display:flex;align-items:center;gap:10px;"><button id="pl" style="background:rgba(212,175,55,0.8);border:none;border-radius:5px;width:40px;height:40px;color:white;font-size:16px;cursor:pointer;">â–¶</button><button id="pa" style="display:none;background:rgba(212,175,55,0.8);border:none;border-radius:5px;width:40px;height:40px;color:white;font-size:16px;cursor:pointer;">â¸</button><button id="st" style="background:rgba(212,175,55,0.8);border:none;border-radius:5px;width:40px;height:40px;color:white;font-size:16px;cursor:pointer;">â¹</button><span id="td" style="margin-left:auto;font-size:14px;color:rgba(255,255,255,0.8);font-family:monospace;">0:00/0:00</span></div></div></div><div id="doc-mini" style="display:none;position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(212,175,55,0.95);border-radius:50%;width:60px;height:60px;cursor:pointer;box-shadow:0 5px 20px rgba(0,0,0,0.5);z-index:200001;">
<button id="doc-mini-close" style="position:absolute;top:-5px;right:-5px;background:rgba(255,255,255,0.95);border:none;border-radius:50%;width:20px;height:20px;font-size:12px;color:rgba(60,60,60,1);cursor:pointer;z-index:2;line-height:1;">âœ•</button>
<div id="doc-mini-icon" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;position:relative;">
<span style="font-size:32px;">ğŸ§</span>
<span id="doc-pause-mark" style="display:none;position:absolute;font-size:48px;color:rgba(255,255,255,0.95);font-weight:300;text-shadow:0 0 10px rgba(0,0,0,0.8);">âœ•</span>
</div>
</div>`;
document.body.insertAdjacentHTML('beforeend',h);
p=document.getElementById('doc-pop');
a=document.getElementById('da');
document.getElementById('listen').onclick=()=>{document.getElementById('ac').style.display='block';a.play();document.getElementById('pl').style.display='none';document.getElementById('pa').style.display='inline-block';};
document.getElementById('pl').onclick=()=>{a.play();document.getElementById('pl').style.display='none';document.getElementById('pa').style.display='inline-block';};
document.getElementById('pa').onclick=()=>{a.pause();document.getElementById('pa').style.display='none';document.getElementById('pl').style.display='inline-block';};
document.getElementById('st').onclick=()=>{a.pause();a.currentTime=0;document.getElementById('pa').style.display='none';document.getElementById('pl').style.display='inline-block';document.getElementById('pb').value=0;};
a.ontimeupdate=()=>{if(a.duration){document.getElementById('pb').value=(a.currentTime/a.duration)*100;const f=s=>Math.floor(s/60)+':'+(Math.floor(s%60)<10?'0':'')+Math.floor(s%60);document.getElementById('td').textContent=f(a.currentTime)+'/'+f(a.duration);}};
document.getElementById('pb').oninput=function(){if(a.duration)a.currentTime=(this.value/100)*a.duration;};
a.onended=()=>{document.getElementById('pa').style.display='none';document.getElementById('pl').style.display='inline-block';document.getElementById('pb').value=0;};
let isDragging=false,dragStartX,dragStartY,popupStartLeft,popupStartTop;
const dragHeader=document.getElementById('doc-drag-header');
if(dragHeader){
dragHeader.onmousedown=function(e){
if(e.target.tagName==='BUTTON'||e.target.closest('button')||e.target.tagName==='INPUT'||e.target.closest('#ac'))return;
isDragging=true;
const rect=p.getBoundingClientRect();
dragStartX=e.clientX;dragStartY=e.clientY;popupStartLeft=rect.left;popupStartTop=rect.top;
p.style.transform='none';p.style.left=popupStartLeft+'px';p.style.top=popupStartTop+'px';
e.preventDefault();
};
document.onmouseleave=function(){isDragging=false;};document.onmousemove=function(e){if(!isDragging)return;if(!isDragging)return;
const deltaX=e.clientX-dragStartX;
const deltaY=e.clientY-dragStartY;
p.style.left=(popupStartLeft+deltaX)+'px';
p.style.top=(popupStartTop+deltaY)+'px';
};
document.onmouseup=function(e){isDragging=false;e.stopPropagation();};window.onmouseup=function(e){isDragging=false;e.stopPropagation();};
}
// ë¯¸ë‹ˆì°½ ì´ë²¤íŠ¸ ì—°ê²°
const miniClose=document.getElementById('doc-mini-close');
const miniIcon=document.getElementById('doc-mini-icon');
const pauseMark=document.getElementById('doc-pause-mark');
if(miniClose && miniIcon){
miniClose.onclick=function(e){
e.stopPropagation();
document.getElementById('doc-mini').style.display='none';
p.style.display='block';const cb=document.getElementById('artwork-close-btn');if(cb)cb.style.display='block';
console.log('âœ… Xë²„íŠ¼â†’ë„ìŠ¨íŠ¸ ë³µì›');
};
miniIcon.onclick=function(){
if(!a.src)return;
if(a.paused){
a.play();
pauseMark.style.display='none';
console.log('â–¶ ì¬ìƒ');
}else{
a.pause();
pauseMark.style.display='block';
console.log('â¸ ì¼ì‹œì •ì§€');
}
};
a.onended=function(){
pauseMark.style.display='none';
};
console.log('âœ… ë¯¸ë‹ˆì°½ ì´ë²¤íŠ¸ ì—°ê²°');
}
// ë¯¸ë‹ˆì°½ ì´ë²¤íŠ¸ ì—°ê²° const miniClose=document.getElementById('doc-mini-close'); const miniIcon=document.getElementById('doc-mini-icon'); const pauseMark=document.getElementById('doc-pause-mark'); if(miniClose && miniIcon){ miniClose.onclick=function(e){ e.stopPropagation(); document.getElementById('doc-mini').style.display='none'; p.style.display='block';const cb=document.getElementById('artwork-close-btn');if(cb)cb.style.display='block'; console.log('âœ… Xë²„íŠ¼â†’ë„ìŠ¨íŠ¸ ë³µì›'); }; miniIcon.onclick=function(){ if(!a.src)return; if(a.paused){ a.play(); pauseMark.style.display='none'; console.log('â–¶ ì¬ìƒ'); }else{ a.pause(); pauseMark.style.display='block'; console.log('â¸ ì¼ì‹œì •ì§€'); } }; a.onended=function(){ pauseMark.style.display='none'; }; console.log('âœ… ë¯¸ë‹ˆì°½ ì´ë²¤íŠ¸ ì—°ê²°'); } 
const closeBtn=document.createElement('button'); closeBtn.id='artwork-close-btn'; closeBtn.innerHTML='âœ•'; closeBtn.style.cssText='display:none;position:fixed;top:30px;right:30px;background:rgba(255,255,255,0.9);border:2px solid rgba(60,60,60,0.3);border-radius:50%;width:50px;height:50px;font-size:28px;color:rgba(60,60,60,1);cursor:pointer;z-index:200002;font-weight:300;box-shadow:0 3px 10px rgba(0,0,0,0.3);'; closeBtn.onclick=function(){window.closeArtwork();}; document.body.appendChild(closeBtn); 
console.log('âœ… 012 ë„ìŠ¨íŠ¸ ìƒì„±');
}
window.openDoc=function(id){const d=data[id];if(!d)return;if(!p)create();document.getElementById('doc-t').textContent=d.title;document.getElementById('doc-d').textContent=d.description;a.src=d.audio;document.getElementById('ac').style.display='none';document.getElementById('pl').style.display='inline-block';document.getElementById('pa').style.display='none';document.getElementById('pb').value=0;p.style.display='block';const cb=document.getElementById('artwork-close-btn');if(cb)cb.style.display='block';console.log('âœ… ë„ìŠ¨íŠ¸:',id);};
window.closeDoc=function(){if(a){a.pause();a.currentTime=0;}if(p)p.style.display='none';};
const c=document.querySelector('canvas');
if(c){let lt=0;c.addEventListener('click',e=>{const n=Date.now();if(n-lt<300){const m={x:(e.clientX/window.innerWidth)*2-1,y:-(e.clientY/window.innerHeight)*2+1};if(window.raycaster&&window.camera&&window.scene){window.raycaster.setFromCamera(m,window.camera);const i=window.raycaster.intersectObjects(window.scene.children,true);for(let j=0;j<i.length;j++){const o=i[j].object;if(o.userData&&o.userData.artworkId){console.log('ğŸ¨ë”ë¸”í´ë¦­:',o.userData.artworkId);if(o.userData.artworkId==='012')window.openDoc('012');break;}}}}lt=n;});console.log('âœ… 012 ë”ë¸”í´ë¦­ ì—°ê²°');}
})();


// ì•ˆì „í•œ ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ (í˜ì´ì§€ ë¡œë“œ í›„ ì‹¤í–‰)
window.addEventListener('load', function() {
  setTimeout(() => {
    const canvas = document.querySelector('canvas');
    if (!canvas) {
      console.error('âŒ Canvas ì—†ìŒ');
      return;
    }
    
    let lastClick = 0;
    
    canvas.addEventListener('click', function(e) {
      const now = Date.now();
      
      if (now - lastClick < 300) {
        // ë”ë¸”í´ë¦­
        const mouse = {
          x: (e.clientX / window.innerWidth) * 2 - 1,
          y: -(e.clientY / window.innerHeight) * 2 + 1
        };
        
        if (window.raycaster && window.camera && window.scene) {
          window.raycaster.setFromCamera(mouse, window.camera);
          const hits = window.raycaster.intersectObjects(window.scene.children, true);
          
          for (let i = 0; i < hits.length; i++) {
            let obj = hits[i].object;
            
            // ë¶€ëª¨ê¹Œì§€ íƒìƒ‰
            while (obj) {
              if (obj.userData && obj.userData.artworkId) {
                console.log('ğŸ¨ ë”ë¸”í´ë¦­:', obj.userData.artworkId);
                window.openDoc(obj.userData.artworkId);
                return;
              }
              obj = obj.parent;
            }
          }
        }
      }
      
      lastClick = now;
    });
    
    console.log('âœ… ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸ ì—°ê²°');
  }, 3000);
});

// ë“œë˜ê·¸ í•´ì œ ê°•í™”
document.addEventListener('mouseup', function() {
  const popup = document.getElementById('doc-pop');
  if (popup) {
    popup.style.cursor = 'move';
  }
}, true);

// ë„ìŠ¨íŠ¸ ë‹«ê¸° í•¨ìˆ˜ (ì‘í’ˆ ë”ë¸”í´ë¦­ ì‹œ í˜¸ì¶œ)
window.closeDoc=function(){
  const popup = document.getElementById('doc-pop');
  const mini = document.getElementById('doc-mini');
  const audio = document.getElementById('da');
  
  if(audio){
    audio.pause();
    audio.currentTime=0;
  }
  
  if(popup) popup.style.display='none';
  if(mini) mini.style.display='none';
  
  console.log('âœ… ë„ìŠ¨íŠ¸ ë‹«ê¸°');
};

// ì‘í’ˆì°½ ë‹«ê¸° í•¨ìˆ˜
window.closeArtwork=function(){
const popup=document.getElementById('doc-pop');
const mini=document.getElementById('doc-mini');
const audio=document.getElementById('da');
if(audio){
audio.pause();
audio.currentTime=0;
}
if(popup)popup.style.display='none';const cb=document.getElementById('artwork-close-btn');if(cb)cb.style.display='none';
if(mini)mini.style.display='none';
console.log('âœ… ì‘í’ˆì°½ ë‹«ê¸°');
};

// ë„ìŠ¨íŠ¸ íŒì—… ë”ë¸”í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
(function(){
setTimeout(()=>{
const popup=document.getElementById('doc-pop');
if(!popup)return;
let lastClick=0;
popup.addEventListener('click',function(e){
if(e.target.tagName==='BUTTON'||e.target.closest('button')||e.target.tagName==='INPUT'||e.target.closest('#ac')||e.target.closest('#listen'))return;
const now=Date.now();
if(now-lastClick<300){
window.closeArtwork();
console.log('âœ… ë”ë¸”í´ë¦­â†’ë‹«ê¸°');
lastClick=0;
}else{
lastClick=now;
}
});
console.log('âœ… íŒì—… ë”ë¸”í´ë¦­ ë‹«ê¸° í™œì„±í™”');
},3000);
})();
